# GitHub Actions ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å
name: æ‰‹å‹•ãƒ“ãƒ«ãƒ‰

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # masterãƒ–ãƒ©ãƒ³ãƒã®pushæ™‚ã«å®Ÿè¡Œ
  push:
    branches:
      - master
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch: {}

# ã‚¸ãƒ§ãƒ–ã®å®šç¾©
jobs:
  cache:
    name: Cache Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: LFSãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®ä½œæˆ
        run: git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id

      - name: LFSã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
        uses: actions/cache@v3
        id: lfs-cache
        with:
          path: .git/lfs
          key: ${{ runner.os }}-lfs-${{ hashFiles('.lfs-assets-id') }}

  build:
    needs: cache
    name: æ‰‹å‹•ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Library ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å‰Šé™¤
        run: rm -rf TestGitHubActions/Library

      - name: Unity Library ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
        id: cache-lib
        uses: actions/cache@v3
        with:
          path: TestGitHubActions/Library
          key: Library-${{ hashFiles('TestGitHubActions/Assets/**', 'TestGitHubActions/Packages/**', 'TestGitHubActions/ProjectSettings/**') }}
          restore-keys: |
            Library-

      - name: Git LFS ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
        run: |
          git lfs pull
          git add .
          git reset --hard

      # ãƒ“ãƒ«ãƒ‰é–‹å§‹ã®é€šçŸ¥ï¼ˆDiscordï¼‰
      - name: ãƒ“ãƒ«ãƒ‰é–‹å§‹é€šçŸ¥
        run: |
          curl -H "Content-Type: application/json" -X POST -d '{
            "content": "ğŸš€ Unity æ‰‹å‹•ãƒ“ãƒ«ãƒ‰é–‹å§‹ï¼\nãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}\nã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}\nãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}\nURL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Windowså‘ã‘ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          targetPlatform: StandaloneWindows64
          unityVersion: 2022.3.62f1
          projectPath: TestGitHubActions

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ ZIP ã«ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: Build-Windows
          path: build

      - name: Unity Library ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¿å­˜
        if: steps.cache-lib.outputs.cache-hit != 'true' && success()
        uses: actions/cache@v3
        with:
          path: TestGitHubActions/Library
          key: Library-${{ hashFiles('TestGitHubActions/Assets/**', 'TestGitHubActions/Packages/**', 'TestGitHubActions/ProjectSettings/**') }}
          restore-keys: |
            Library-

      # ãƒ“ãƒ«ãƒ‰æˆåŠŸã®é€šçŸ¥ï¼ˆDiscordï¼‰
      - name: ãƒ“ãƒ«ãƒ‰æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          curl -H "Content-Type: application/json" -X POST -d '{
            "content": "âœ… Unity æ‰‹å‹•ãƒ“ãƒ«ãƒ‰æˆåŠŸ ğŸ‰\nãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}\nã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}\nãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}\nURL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ãƒ“ãƒ«ãƒ‰å¤±æ•—ã®é€šçŸ¥ï¼ˆDiscordï¼‰
      - name: ãƒ“ãƒ«ãƒ‰å¤±æ•—é€šçŸ¥
        if: failure()
        run: |
          curl -H "Content-Type: application/json" -X POST -d '{
            "content": "âŒ Unity æ‰‹å‹•ãƒ“ãƒ«ãƒ‰å¤±æ•— ğŸ’¥\nãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}\nã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}\nãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}\nURL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}
